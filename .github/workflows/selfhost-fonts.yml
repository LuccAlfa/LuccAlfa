on:
  workflow_dispatch:

jobs:
  fetch-fonts:
    runs-on: ubuntu-latest
    name: Fetch and self-host Google Fonts
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare directories
        run: |
          mkdir -p assets/fonts

      - name: Fetch Google Fonts CSS
        env:
          GOOGLE_FONTS_CSS: "https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@400;500&display=swap"
        run: |
          set -euo pipefail
          curl -s -A "Mozilla/5.0 (compatible;)" "$GOOGLE_FONTS_CSS" -o /tmp/gf.css
          echo "Saved /tmp/gf.css (size: $(stat -c%s /tmp/gf.css) bytes)"

      - name: Extract and download font files
        run: |
          set -euo pipefail
          grep -oE "url\([^)]+\)" /tmp/gf.css | sed -E "s/url\((https?:[^)]*)\)/\1/" | sed 's/^"//' | sed "s/^'//" | sed 's/"$//' | sed "s/'$//" | sort -u > /tmp/font-urls.txt || true
          echo "Font URLs:"
          sed -n '1,200p' /tmp/font-urls.txt || true
          while IFS= read -r url; do
            [ -z "$url" ] && continue
            fname=$(basename "${url%%\?*}")
            if [ ! -f "assets/fonts/$fname" ]; then
              echo "Downloading $url -> assets/fonts/$fname"
              curl -fL "$url" -o "assets/fonts/$fname"
            else
              echo "Already exists: assets/fonts/$fname"
            fi
          done < /tmp/font-urls.txt || true

      - name: Generate fonts.css (local references + font-display)
        run: |
          python3 scripts/selfhost_fonts.py /tmp/gf.css assets/fonts/fonts.css
          echo "=== fonts.css head ==="
          sed -n '1,140p' assets/fonts/fonts.css || true

      - name: Commit downloaded fonts and generated CSS
        env:
          GIT_AUTHOR_NAME: "github-actions[bot]"
          GIT_AUTHOR_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"
        run: |
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"
          git add assets/fonts || true
          git commit -m "chore: add self-hosted fonts (Montserrat, Roboto)" || echo "nothing to commit"
          git push || echo "git push failed (possibly branch protection). If so, consider creating a branch + PR instead."
